{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "Patient Details" %} | {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .document-card {
        transition: all 0.3s ease;
    }
    .document-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .section-header {
        position: relative;
    }
    .section-header:after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        width: 40px;
        height: 3px;
        background-color: #3B82F6;
        border-radius: 2px;
    }
    .fade-in {
        opacity: 0;
        animation: fadeIn 0.5s ease forwards;
    }
    .slide-in {
        transform: translateX(-20px);
        opacity: 0;
        animation: slideIn 0.5s ease forwards;
    }
    @keyframes fadeIn {
        to { opacity: 1; }
    }
    @keyframes slideIn {
        to { 
            transform: translateX(0);
            opacity: 1;
        }
    }
    .tab-group {
        border-bottom: 1px solid #e5e7eb;
    }
    .tab-item {
        position: relative;
        cursor: pointer;
    }
    .tab-item.active:after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #3B82F6;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen pb-12">
    <!-- Header Section -->
    <div class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-900">{{ patient.get_full_name }}</h1>
                    <p class="mt-1 text-sm text-gray-500">
                        {% if patient.date_of_birth %}
                            {% trans "Born" %}: {{ patient.date_of_birth|date:"F j, Y" }} ({{ patient.age }} {% trans "years" %})
                        {% endif %}
                        {% if patient.language %}
                            | {% trans "Preferred Language" %}: {{ patient.language }}
                        {% endif %}
                    </p>
                </div>
                <div class="flex space-x-2">
                    <a href="#appointments" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {% trans "Schedule Appointment" %}
                    </a>
                    <a href="#message" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-0.5 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        {% trans "Send Message" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Tabs -->
        <div class="tab-group flex border-b border-gray-200 mb-6">
            <div class="tab-item active px-4 py-3 text-sm font-medium text-blue-600" data-tab="overview">
                {% trans "Overview" %}
            </div>
            <div class="tab-item px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="documents">
                {% trans "Documents" %}
            </div>
            <div class="tab-item px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="reviews">
                {% trans "Clinical Notes" %}
            </div>
            <div class="tab-item px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="test-results">
                {% trans "Test Results" %}
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Overview Tab (default active) -->
            <div id="overview-content" class="tab-pane active">
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
                    <!-- Patient Information Card -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg fade-in" style="animation-delay: 0.1s;">
                        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                                {% trans "Patient Information" %}
                            </h3>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Email" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {{ patient.email }}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Phone" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {{ patient.phone_number|default:_("Not provided") }}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Address" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if patient.address %}
                                        {{ patient.address }}
                                        {% else %}
                                        {% trans "Not provided" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Emergency Contact" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if patient.emergency_contact %}
                                        {{ patient.emergency_contact }}
                                        {% else %}
                                        {% trans "Not provided" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Patient since" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {{ patient.date_joined|date:"F j, Y" }}
                                    </dd>
                                </div>
                            </dl>
                        </div>
                    </div>

                    <!-- Medical Record Card -->
                    <div class="lg:col-span-2 bg-white shadow overflow-hidden sm:rounded-lg fade-in" style="animation-delay: 0.2s;">
                        <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                                {% trans "Medical Record" %}
                            </h3>
                            <a href="{% url 'medical:clinician_edit_patient_record' patient.id %}" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                                {% trans "Edit record" %}
                            </a>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            {% if medical_record %}
                            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Cancer Type" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if medical_record.cancer_type %}
                                        {{ medical_record.cancer_type.name }}
                                        {% else %}
                                        {% trans "Not specified" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Cancer Stage" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if medical_record.cancer_stage_text %}
                                        {{ medical_record.cancer_stage_text }}
                                        {% if medical_record.stage_grouping %}
                                        ({{ medical_record.stage_grouping }})
                                        {% endif %}
                                        {% else %}
                                        {% trans "Not staged" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-1">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Diagnosis Date" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if medical_record.diagnosis_date %}
                                        {{ medical_record.diagnosis_date|date:"F j, Y" }}
                                        {% else %}
                                        {% trans "Not specified" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Recommended Treatment" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if medical_record.recommended_treatment %}
                                        {{ medical_record.recommended_treatment }}
                                        {% else %}
                                        {% trans "No treatment plan specified" %}
                                        {% endif %}
                                    </dd>
                                </div>
                                <div class="sm:col-span-2">
                                    <dt class="text-sm font-medium text-gray-500">
                                        {% trans "Medical Notes" %}
                                    </dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        {% if medical_record.notes %}
                                        {{ medical_record.notes }}
                                        {% else %}
                                        {% trans "No notes" %}
                                        {% endif %}
                                    </dd>
                                </div>
                            </dl>
                            {% else %}
                            <div class="py-4 text-center">
                                <p class="text-sm text-gray-500 mb-4">{% trans "No medical record found for this patient." %}</p>
                                <a href="{% url 'medical:clinician_edit_patient_record' patient.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    {% trans "Create medical record" %}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">
                    <!-- Recent Document Card -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg fade-in" style="animation-delay: 0.3s;">
                        <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                                {% trans "Recent Documents" %}
                            </h3>
                            <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500" data-tab="documents" id="view-all-documents">
                                {% trans "View all" %}
                            </a>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            {% if documents %}
                            <ul class="divide-y divide-gray-200">
                                {% for document in documents|slice:":3" %}
                                <li class="py-3">
                                    <div class="flex justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">{{ document.title }}</p>
                                            <p class="text-xs text-gray-500">{{ document.uploaded_at|date:"M d, Y" }}</p>
                                        </div>
                                        <a href="{% url 'medical:view_medical_document' document.id %}" class="text-sm text-blue-600 hover:text-blue-500">
                                            {% trans "View" %}
                                        </a>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-center py-4">
                                <p class="text-sm text-gray-500 mb-4">{% trans "No documents uploaded yet." %}</p>
                                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                        hx-get="{% url 'medical:clinician_upload_document' patient.id %}"
                                        hx-target="#modal-container"
                                        hx-swap="innerHTML">
                                    {% trans "Upload document" %}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% if documents %}
                        <div class="bg-gray-50 px-4 py-4 sm:px-6">
                            <button type="button" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    hx-get="{% url 'medical:clinician_upload_document' patient.id %}"
                                    hx-target="#modal-container"
                                    hx-swap="innerHTML">
                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                {% trans "Upload new document" %}
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Recent Clinical Notes Card -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg fade-in" style="animation-delay: 0.4s;">
                        <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                                {% trans "Recent Clinical Notes" %}
                            </h3>
                            <a href="#" class="text-sm font-medium text-blue-600 hover:text-blue-500" data-tab="reviews" id="view-all-notes">
                                {% trans "View all" %}
                            </a>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            {% if reviews %}
                            <ul class="divide-y divide-gray-200">
                                {% for review in reviews|slice:":3" %}
                                <li class="py-3">
                                    <p class="text-sm font-medium text-gray-900">{{ review.review_date|date:"M d, Y" }}</p>
                                    <p class="text-xs text-gray-500 mb-1">{{ review.clinician.get_full_name }}</p>
                                    <p class="text-sm text-gray-700">{{ review.notes|truncatechars:100 }}</p>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-center py-4">
                                <p class="text-sm text-gray-500 mb-4">{% trans "No clinical notes added yet." %}</p>
                                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                        hx-get="{% url 'medical:clinician_add_review' patient.id %}"
                                        hx-target="#modal-container"
                                        hx-swap="innerHTML">
                                    {% trans "Add note" %}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        {% if reviews %}
                        <div class="bg-gray-50 px-4 py-4 sm:px-6">
                            <button type="button" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    hx-get="{% url 'medical:clinician_add_review' patient.id %}"
                                    hx-target="#modal-container"
                                    hx-swap="innerHTML">
                                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                {% trans "Add new note" %}
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Upcoming Appointments Card -->
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg fade-in" style="animation-delay: 0.5s;">
                        <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                                {% trans "Upcoming Appointments" %}
                            </h3>
                        </div>
                        <div class="px-4 py-5 sm:p-6">
                            {% if appointments %}
                            <ul class="divide-y divide-gray-200">
                                {% for appointment in appointments %}
                                <li class="py-3">
                                    <p class="text-sm font-medium text-gray-900">{{ appointment.date|date:"M d, Y" }} at {{ appointment.time|time:"g:i A" }}</p>
                                    <p class="text-xs text-gray-500">{{ appointment.appointment_type }}</p>
                                    <p class="text-xs text-gray-500">{{ appointment.location|default:"-" }}</p>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <div class="text-center py-4">
                                <p class="text-sm text-gray-500 mb-4">{% trans "No upcoming appointments scheduled." %}</p>
                                <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    {% trans "Schedule appointment" %}
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="documents-content" class="tab-pane hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between items-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                            {% trans "Patient Documents" %}
                        </h3>
                        <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                hx-get="{% url 'medical:clinician_upload_document' patient.id %}"
                                hx-target="#modal-container"
                                hx-swap="innerHTML">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            {% trans "Upload document" %}
                        </button>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        {% if documents %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for document in documents %}
                            <div class="bg-white border border-gray-200 rounded-lg shadow-sm document-card">
                                <div class="p-4 flex flex-col h-full">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-shrink-0 bg-blue-100 rounded-md p-2 mr-3">
                                            <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <h4 class="text-sm font-medium text-gray-900">{{ document.title }}</h4>
                                            <p class="text-xs text-gray-500">{{ document.document_type }}</p>
                                        </div>
                                    </div>
                                    
                                    {% if document.description %}
                                    <div class="mt-2 flex-grow">
                                        <p class="text-sm text-gray-700">{{ document.description }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if document.ai_analysis_json %}
                                    <div class="mt-2 p-3 bg-blue-50 rounded-md">
                                        <h5 class="font-semibold text-xs text-blue-800 mb-1">{% trans "AI Analysis Results" %}</h5>
                                        <div class="grid grid-cols-1 gap-y-1">
                                            <div class="text-xs">
                                                <span class="font-medium text-gray-700">{% trans "Cancer Type:" %}</span>
                                                <span class="text-gray-900">{{ document.ai_analysis_json.cancer_type }}</span>
                                            </div>
                                            <div class="text-xs">
                                                <span class="font-medium text-gray-700">{% trans "FIGO Stage:" %}</span>
                                                <span class="text-gray-900">{{ document.ai_analysis_json.figo_stage }}</span>
                                            </div>
                                            <div class="text-xs">
                                                <span class="font-medium text-gray-700">{% trans "Final Path. Stage:" %}</span>
                                                <span class="text-gray-900">{{ document.ai_analysis_json.final_pathologic_stage|striptags|safe }}</span>
                                            </div>
                                            {% if document.ai_analysis_json.recommended_treatment %}
                                            <div class="text-xs">
                                                <span class="font-medium text-gray-700">{% trans "NCCN Treatment:" %}</span>
                                                <span class="text-gray-900">{{ document.ai_analysis_json.recommended_treatment|truncatechars:40 }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-4 flex justify-between items-center">
                                        <div>
                                            <p class="text-xs text-gray-500">{{ document.uploaded_at|date:"M d, Y" }}</p>
                                            <p class="text-xs text-gray-500">{{ document.uploaded_by.get_full_name }}</p>
                                        </div>
                                        <a href="{% url 'medical:view_medical_document' document.id %}" class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-500">
                                            <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            {% trans "View" %}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">{% trans "No documents" %}</h3>
                            <p class="mt-1 text-sm text-gray-500">{% trans "Get started by uploading a new document." %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Clinical Notes Tab -->
            <div id="reviews-content" class="tab-pane hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 border-b border-gray-200 sm:px-6 flex justify-between items-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                            {% trans "Clinical Notes" %}
                        </h3>
                        <button type="button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                hx-get="{% url 'medical:clinician_add_review' patient.id %}"
                                hx-target="#modal-container"
                                hx-swap="innerHTML">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            {% trans "Add note" %}
                        </button>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        {% if reviews %}
                        <div class="flow-root">
                            <ul class="-mb-8">
                                {% for review in reviews %}
                                <li>
                                    <div class="relative pb-8">
                                        {% if not forloop.last %}
                                        <span class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                        {% endif %}
                                        <div class="relative flex items-start space-x-3">
                                            <div class="relative">
                                                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center ring-8 ring-white">
                                                    <svg class="h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                    </svg>
                                                </div>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">
                                                        {{ review.clinician.get_full_name }}
                                                    </div>
                                                    <p class="mt-0.5 text-sm text-gray-500">
                                                        {{ review.review_date|date:"F j, Y" }} at {{ review.review_date|time:"g:i A" }}
                                                    </p>
                                                </div>
                                                <div class="mt-2 text-sm text-gray-700 whitespace-pre-line">
                                                    {{ review.notes }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">{% trans "No clinical notes" %}</h3>
                            <p class="mt-1 text-sm text-gray-500">{% trans "Start by adding a new clinical note." %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Test Results Tab -->
            <div id="test-results-content" class="tab-pane hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 border-b border-gray-200 sm:px-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 section-header">
                            {% trans "Test Results" %}
                        </h3>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <div class="text-center py-12">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">{% trans "No test results" %}</h3>
                            <p class="mt-1 text-sm text-gray-500">{% trans "Test results will appear here when available." %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal container for forms -->
<div id="modal-container" class="hidden"></div>
{% endblock %}

{% block extra_js %}
<!-- Add document handling scripts -->
<script src="{% static 'js/document_transition.js' %}"></script>
<script src="{% static 'js/document_upload.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab-item');
        const tabPanes = document.querySelectorAll('.tab-pane');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.getAttribute('data-tab');

                // Hide all tab panes
                tabPanes.forEach(pane => {
                    pane.classList.add('hidden');
                    pane.classList.remove('active');
                });

                // Show target tab pane
                const targetPane = document.getElementById(`${targetId}-content`);
                if (targetPane) {
                    targetPane.classList.remove('hidden');
                    targetPane.classList.add('active');
                }

                // Update active tab styling
                tabs.forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-gray-500');
                    t.classList.remove('text-blue-600');
                });

                tab.classList.add('active');
                tab.classList.remove('text-gray-500');
                tab.classList.add('text-blue-600');
            });
        });

        // Handle "View all" links
        document.getElementById('view-all-documents').addEventListener('click', function(e) {
            e.preventDefault();
            const tabToActivate = document.querySelector('[data-tab="documents"]');
            tabToActivate.click();
        });

        document.getElementById('view-all-notes').addEventListener('click', function(e) {
            e.preventDefault();
            const tabToActivate = document.querySelector('[data-tab="reviews"]');
            tabToActivate.click();
        });

        // IMPROVED HTMX MODAL HANDLING
        // First, handle all buttons that open modals
        document.querySelectorAll('[hx-target="#modal-container"]').forEach(button => {
            button.addEventListener('click', function() {
                // Before we load a new modal, properly clear old content
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) {
                    // Clear existing content
                    modalContainer.innerHTML = '';
                    // Make visible
                    modalContainer.classList.remove('hidden');
                    modalContainer.style.display = 'block';
                    console.log('Modal container prepared for new content');
                }
            });
        });

        // Handle content loaded into modal
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'modal-container') {
                // Make sure modal container is visible
                const modalContainer = document.getElementById('modal-container');
                modalContainer.classList.remove('hidden');
                modalContainer.style.display = 'block';
                console.log('Modal content loaded via HTMX');

                // Re-initialize document upload after modal is loaded
                if (typeof initializeDocumentUpload === 'function') {
                    console.log('Reinitializing document upload for newly loaded modal');
                    setTimeout(initializeDocumentUpload, 100);
                }

                // Check for our new direct setup function
                if (typeof window.setupDocumentUploadDragDrop === 'function') {
                    console.log('Setting up drag and drop with direct function');
                    const fileDropZone = document.getElementById('file-drop-zone');
                    const fileInput = document.querySelector('input[type="file"][accept=".pdf"]');

                    if (fileDropZone && fileInput) {
                        console.log('Found file drop zone and input, calling direct setup');
                        setTimeout(() => {
                            window.setupDocumentUploadDragDrop(fileDropZone, fileInput);
                        }, 50);
                    }
                }
            }
        });

        // Listen for modal closing in a more robust way
        document.body.addEventListener('click', function(event) {
            // Look for clicks on modal close buttons or overlays
            if (event.target.closest('[onclick*="closeAndResetModal"]') ||
                (event.target.classList.contains('backdrop-blur-sm') && !event.target.closest('.rounded-2xl'))) {
                console.log('Modal close detected via click, preparing for future use');

                // Use setTimeout to avoid HTMX conflicts
                setTimeout(() => {
                    const modalContainer = document.getElementById('modal-container');
                    if (modalContainer) {
                        modalContainer.classList.add('hidden');
                        modalContainer.style.display = 'none';

                        // Carefully empty the container after a delay
                        setTimeout(() => {
                            modalContainer.innerHTML = '';
                            console.log('Modal container safely emptied');
                        }, 150);
                    }
                }, 50);
            }
        });

        // Re-initialize the dashboard after document uploads
        document.body.addEventListener('documentUploaded', function(event) {
            window.location.reload();
        });

        document.body.addEventListener('recordUpdated', function(event) {
            window.location.reload();
        });

        // ESC key closes modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer && !modalContainer.classList.contains('hidden')) {
                    modalContainer.innerHTML = '';
                    modalContainer.classList.add('hidden');
                    modalContainer.style.display = 'none';
                    console.log('Modal closed by ESC key');
                }
            }
        });
    });
</script>
{% endblock %}